name: CI/CD Pipeline con Condiciones

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
  pull_request:
    branches:
      - main
      - develop

env:
  NODE_VERSION: '18'

jobs:
  # ============================================
  # JOB 1: BUILD
  # Se ejecuta SIEMPRE (cualquier rama/evento)
  # ============================================
  build:
    name: Build Application
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Step 1 - Basic file operations
        id: step1
        run: |
          echo "ğŸ§ª STEP 1: Testing basic file operations..."
          pwd
          ls -la
          echo "âœ… Step 1 completed successfully"
      
      - name: Step 2 - Create directory
        id: step2
        run: |
          echo "ğŸ§ª STEP 2: Creating directories..."
          mkdir -p dist
          ls -la
          echo "âœ… Step 2 completed successfully"
      
      - name: Step 3 - Setup Node.js
        id: step3
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Step 4 - Verify Node.js
        id: step4
        run: |
          echo "ğŸ§ª STEP 4: Verifying Node.js..."
          node --version
          npm --version
          echo "âœ… Step 4 completed successfully"
      
      - name: Step 5 - Check for package.json
        id: step5
        run: |
          echo "ğŸ§ª STEP 5: Checking for package.json..."
          if [ ! -f "package.json" ]; then
            echo "Creating package.json..."
            # Use simple echo commands instead of here-document
            echo '{' > package.json
            echo '  "name": "linux_tweet_app",' >> package.json
            echo '  "version": "1.0.0",' >> package.json
            echo '  "scripts": {' >> package.json
            echo '    "build": "echo \"Build complete\" && mkdir -p dist && echo \"<h1>Linux Tweet App</h1>\" > dist/index.html"' >> package.json
            echo '  }' >> package.json
            echo '}' >> package.json
            echo "âœ… Created package.json"
          else
            echo "âœ… package.json already exists"
            cat package.json
          fi
          echo "âœ… Step 5 completed successfully"
      
      - name: Step 6 - Try npm install
        id: step6
        run: |
          echo "ğŸ§ª STEP 6: Attempting npm install..."
          npm install --loglevel=verbose
          echo "âœ… Step 6 completed successfully"
      
      - name: Step 7 - Try build
        id: step7
        run: |
          echo "ğŸ§ª STEP 7: Attempting build..."
          npm run build
          echo "âœ… Step 7 completed successfully"
      
      - name: Upload build artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact
          path: dist/
          retention-days: 1

  # ============================================
  # JOB 2: TEST
  # Se ejecuta SIEMPRE (cualquier rama/evento)
  # ============================================
  env:
    NODE_VERSION: '18'  # Add this at job or workflow level
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm install
      
      - name: Run unit tests
        run: |
          echo "ğŸ§ª Running unit tests..."
          npm test
          echo "âœ… All tests passed!"
      
      - name: Run linting
        run: |
          echo "ğŸ” Running linter..."
          npm run lint
          echo "âœ… Code quality check passed!"

  # ============================================
  # JOB 3: DEPLOY TO STAGING
  # Se ejecuta SOLO en Pull Requests
  # ============================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build, test]
    if: github.event_name == 'pull_request'
    environment:
      name: staging
      url: https://staging.miapp.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: build-artifact
          path: dist/
      
      - name: Deploy to Staging
        run: |
          echo "ğŸš€ Deploying to STAGING environment..."
          echo "PR #${{ github.event.pull_request.number }}"
          echo "Branch: ${{ github.head_ref }}"
          # AquÃ­ irÃ­an comandos reales de deploy
          # kubectl apply -f k8s/staging/
          # o deploy a heroku, vercel, etc.
          sleep 2
          echo "âœ… Deployed to staging successfully!"
      
      - name: Run smoke tests on staging
        run: |
          echo "ğŸ”¥ Running smoke tests on staging..."
          # curl -f https://staging.miapp.com/health || exit 1
          echo "âœ… Smoke tests passed!"
      
      - name: Comment on PR
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸš€ Deployed to *Staging*: https://staging.miapp.com\n\nâœ… Smoke tests passed!'
            })

  # ============================================
  # JOB 4: DEPLOY TO PRODUCTION
  # Se ejecuta SOLO en push a main
  # ============================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://miapp.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download build artifact
        uses: actions/download-artifact@v3
        with:
          name: build-artifact
          path: dist/
      
      - name: Deploy to Production
        run: |
          echo "ğŸš€ Deploying to PRODUCTION environment..."
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"
          # AquÃ­ irÃ­an comandos reales de deploy
          # kubectl apply -f k8s/production/
          sleep 2
          echo "âœ… Deployed to production successfully!"
      
      - name: Run smoke tests on production
        run: |
          echo "ğŸ”¥ Running smoke tests on production..."
          # curl -f https://miapp.com/health || exit 1
          echo "âœ… Smoke tests passed!"
      
      - name: Create deployment notification
        run: |
          echo "ğŸ“¢ Notifying team about production deployment..."
          echo "Version: ${{ github.sha }}"
          # AquÃ­ se integrarÃ­a Slack, Teams, email, etc.
          echo "âœ… Notification sent!"

  # ============================================
  # JOB 5: SUMMARY
  # Se ejecuta SIEMPRE para mostrar resumen
  # ============================================
  summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [build, test]
    if: always()
    
    steps:
      - name: Show pipeline summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š PIPELINE SUMMARY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Event: ${{ github.event_name }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"
          echo ""
          echo "âœ… Build: ${{ needs.build.result }}"
          echo "âœ… Test: ${{ needs.test.result }}"
          echo ""
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "ğŸ¯ Target: STAGING deployment"
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "ğŸ¯ Target: PRODUCTION deployment"
          else
            echo "ğŸ¯ Target: Build & Test only"
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"